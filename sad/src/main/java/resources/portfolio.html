<!DOCTYPE html>
<html lang="en">
	<head>
		<!--  Meta tags  -->
		<meta charset="UTF-8" />
		<title>SAD Project</title>
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0" />
		<!-- Website desc for SEO -->
		<meta
			name="description"
			content="Architecture and Design Coursework" />
		<meta
			name="author"
			content="MMadejsza, AdamT-S, Raja108N, unaisq1" />
		<meta
			name="keywords"
			content="SAD, stock, Java, architecture, n-tiered, adapter" />

		<!-- FAVICONS info -->
		<link
			rel="icon"
			href="./favicon.png"
			type="image/png"
			sizes="18x18" />

		<!-- Outside styling and links info -->
		<link
			rel="preconnect"
			href="https://fonts.googleapis.com" />
		<link
			rel="preconnect"
			href="https://fonts.gstatic.com"
			crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
			rel="stylesheet" />
		<link
			rel="stylesheet"
			href="./style.css" />
		<link
			rel="stylesheet"
			href="./portfolio.css" />
	</head>
	<body>
		<nav class="nav">
			<ul>
				<li>
					<a href="./"><i class="fas fa-home"></i>Home</a>
				</li>
				<li>
					<a href="./login"><i class="fas fa-user"></i>Login</a>
				</li>
				<li>
					<a class="active"><i class="fas fa-search-dollar"></i>Portfolio</a>
				</li>
				<li>
					<a href="./about"><i class="far fa-copyright"></i>About</a>
				</li>
				<li class="wrench">
					<i class="fas fa-wrench"></i>
					<ul class="colorSettingsList">
						<li class="settings">
							<input
								type="color"
								id="inputColor" />
						</li>
					</ul>
				</li>
			</ul>
		</nav>
		<header>
			<main class="contentBox">
				<div class="addCompanyBox">
					Add a company
					<input
						class="addInput"
						type="text"
						placeholder="Company Yahoo Code" />
				</div>
			</main>
		</header>
		<script
			src="https://kit.fontawesome.com/4622d99ad4.js"
			crossorigin="anonymous"></script>
		<script name="./js/app.js">
			document.addEventListener('DOMContentLoaded', function () {
				const checkbox = document.getElementById('registerInput');
				const registerForm = document.querySelector('.registerForm');
				const colorInput = document.querySelector('#inputColor');
				const baseColor = getComputedStyle(document.documentElement).getPropertyValue(
					'--defaultColor',
				);

				colorInput.value = baseColor;

				try {
					checkbox.addEventListener('change', function () {
						if (checkbox.checked) {
							registerForm.classList.add('active');
						} else {
							registerForm.classList.remove('active');
						}
					});
				} catch (error) {}

				try {
					colorInput.addEventListener('input', (e) => {
						// make shortcut for html element
						const root = document.documentElement;
						// catch picked color
						let newColor = e.target.value;

						// substitute css variable with picked color
						root.style.setProperty('--defaultColor', `${newColor}`);

						// catch desired opacity from css
						let alpha1 = getComputedStyle(root).getPropertyValue('--shadowAlpha1');
						let alpha2 = getComputedStyle(root).getPropertyValue('--shadowAlpha2');
						// substitute css variable for shadows with picked opacity
						const setOpacity = (alpha) =>
							`${newColor}${Math.floor(alpha * 255)
								.toString(16)
								.padStart(2, 0)}`;
						// set new shadow colors
						root.style.setProperty('--shadowColor1', `${setOpacity(alpha1)}`);
						root.style.setProperty('--shadowColor2', `${setOpacity(alpha2)}`);
					});
				} catch (error) {}

				try {
					document.querySelector('.accessBtn').addEventListener('click', () => {
						// Send an HTTP GET request to the server
						fetch('/call-java-function')
							.then((response) => response.text())
							.then((data) => console.log(data))
							.catch((error) => console.error('Error:', error));
					});
				} catch (error) {}
			});
		</script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script name="./js/portfolio.js">
			document.addEventListener('DOMContentLoaded', function () {
				const portfolio = document.querySelector('.contentBox');
				const addInput = document.querySelector('.addInput');

				// CHART PART
				const generateChart = (name, startDate = '2022-02-01', endDate = '2024-12-01') => {
					console.log(`Traced startDate: ${startDate}
					Traced endDate: ${endDate}`);
					// Catch defaultColor

					const baseColor = getComputedStyle(document.documentElement).getPropertyValue(
						'--defaultColor',
					);
					// Catch container
					const ctx = document.getElementById('myChart');
					// Destroy existing chart if it exists
					const existingChart = Chart.getChart('myChart');
					if (existingChart) existingChart.destroy();

					// Generate label for each date in a range
					const getDaysArray = function () {
						let arr = [];
						for (
							let dt = new Date(startDate);
							dt <= new Date(endDate);
							dt.setDate(dt.getDate() + 1)
						) {
							let readyDate = new Date(dt).toLocaleDateString();
							arr.push(readyDate);
						}
						return arr;
					};
					// Draw graph
					const newChart = new Chart(ctx, {
						type: 'line',
						data: {
							labels: getDaysArray(),
							datasets: [
								{
									label: name,
									data: [
										65, 59, 80, 81, 56, 55, 40, 59, 80, 81, 56, 55, 40, 59, 80,
									],
									fill: false,
									borderColor: baseColor,
									tension: 0.1,
								},
							],
						},
						options: {
							scales: {
								y: {
									beginAtZero: true,
								},
							},
						},
					});
				};

				const serveDeleteBtns = () => {
					const deleteBtns = document.querySelectorAll('.delete');

					[...deleteBtns].forEach((deleteBtn) =>
						deleteBtn.addEventListener('click', (e) => {
							const parentGraphBox = deleteBtn.closest('.graphBox');
							parentGraphBox.remove();
						}),
					);
				};

				const serveDateInputs = () => {
					// const startDateInputs = document.querySelectorAll('.startDateInput');
					// const endDateInputs = document.querySelectorAll('.endDateInput');
					const dateInputs = document.querySelectorAll("input[type='date']");

					[...dateInputs].forEach((input) => {
						const chartLabelEl = input.closest('.graph-label');
						const chartName = chartLabelEl.querySelector('h2').textContent;

						if (input.className == 'startDateInput') {
							input.addEventListener('input', (e) => {
								const otherInputVal =
									chartLabelEl.querySelector('.endDateInput').value;
								console.log(e.target.value);
								generateChart(
									chartName,
									e.target.value,
									otherInputVal ? otherInputVal : undefined,
								);
							});
						} else if (input.className == 'endDateInput') {
							input.addEventListener('input', (e) => {
								const otherInputVal =
									chartLabelEl.querySelector('.startDateInput').value;
								console.log(e.target.value);
								generateChart(
									chartName,
									otherInputVal ? otherInputVal : undefined,
									e.target.value,
								);
							});
						}
					});
				};

				const changeGrid = () => {
					if (portfolio.childElementCount <= 2) {
						portfolio.style.setProperty(
							'grid-template-columns',
							'minmax(560px, 800px)',
						);
					} else
						portfolio.style.setProperty(
							'grid-template-columns',
							'repeat(auto-fill, minmax(560px, 600px))',
						);
				};

				const linkActions = () => {
					changeGrid();
					serveDeleteBtns();
					serveDateInputs();
				};

				linkActions();

				addInput.addEventListener('change', (e) => {
					const graphBox = document.createElement('div');

					graphBox.setAttribute('class', 'graphBox');

					graphBox.innerHTML = `<button class="delete">X</button>
					<div class="graph">
						<canvas id="myChart" width="100%">
						</div>
					<div class="graph-label">
						<input class = "startDateInput" type="date" />
						<h2 class = "graph-label-name">${e.target.value}</h2>
						<input class = "endDateInput" type="date" />
					</div>`;

					// Insert as first child
					portfolio.insertBefore(graphBox, portfolio.firstChild);

					// Generate Initial Graph
					generateChart(e.target.value);

					// Linking all buttons and inputs
					linkActions();

					// Clear input
					e.target.value = '';
				});
			});
		</script>
	</body>
</html>
